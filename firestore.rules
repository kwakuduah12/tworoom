rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  
  	// OTP requests (email login)
    match /otp_requests/{email} {
        // Allow create/update for unauthenticated users (login step)
        allow create, update, delete: if true;

        // Allow read only during verification
        allow read: if true;
      }

    match /couples/{coupleId} {

      // READ
      allow read: if request.auth != null
        && request.auth.uid in resource.data.members;

      // CREATE
      allow create: if request.auth != null
        && request.auth.uid in request.resource.data.members
        && request.resource.data.members.size() <= 2
        && request.resource.data.keys().hasAll(['members', 'createdAt'])
        && request.resource.data.createdAt is timestamp;

      // UPDATE (no member changes, controlled fields only)
      allow update: if request.auth != null
        && request.auth.uid in resource.data.members
        && request.resource.data.members == resource.data.members
        && request.resource.data.keys().hasOnly([
          'members',
          'createdAt',
          'nextVisitDate',
          'milestones'
        ]);

      // DELETE
      allow delete: if request.auth != null
        && request.auth.uid in resource.data.members;
      
      // MESSAGES (example subcollection)
      match /messages/{messageId} {

        allow read: if request.auth != null
          && request.auth.uid in get(
            /databases/$(database)/documents/couples/$(coupleId)
          ).data.members;

        allow create: if request.auth != null
          && request.auth.uid in get(
            /databases/$(database)/documents/couples/$(coupleId)
          ).data.members
          && request.resource.data.senderId == request.auth.uid
          && request.resource.data.text is string
          && request.resource.data.text.size() <= 10000
          && request.resource.data.timestamp is timestamp;

        allow update, delete: if request.auth != null
          && request.auth.uid == resource.data.senderId;
      }
    }
  }
}